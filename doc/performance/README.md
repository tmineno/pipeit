# Performance Characterization Reports

`doc/performance/` stores one Markdown report per benchmarked snapshot:

- `<timestamp>-<id>-bench.md`

The report is generated by `benches/commit_characterize.sh`.

## Filename Rule

- `<timestamp> = date +%Y%m%dT%H%M%S`
- `<id> = commit id resolved by --commit-id or --id-source`

Example:

- `20260228T080903-585f144-bench.md`

## ID Rule

- `--commit-id <id>`:
  - Uses the explicit id as-is.
- `--id-source head`:
  - `<id> = git rev-parse --short=7 HEAD`
- `--id-source staged-diff`:
  - `<id> = first 12 chars of sha1(staged diff)`
  - Staged diff excludes existing benchmark reports:
    - `:(exclude)doc/performance/*-bench.md`
  - If staged diff is empty, falls back to `git rev-parse --short=7 HEAD`.
  - This is stable across pre-commit retries and avoids infinite report regeneration loops.

## Generation Guard

- If `HEAD~1..HEAD` has no changes in:
  - `compiler/src/*.rs`
  - `compiler/tests/*.rs`
- Then `commit_characterize.sh` exits early and does not generate a report.

## Fixed Output Format

Each report always includes these sections in order:

1. Metadata (`ID`, `HEAD`, `Branch`, previous report)
2. Commands used
3. Status (`runtime/e2e`, `compile`)
4. Full compile latency table (`simple`, `multitask`, `complex`, `modal`)
5. Phase latency table (complex scenario: `build_thir_context`, `build_lir`, `emit_cpp`)
6. Runtime deadline miss rate table (`1kHz`, `10kHz`, `48kHz`)
7. Ring buffer contention table (`1/2/4/8 readers`)
8. E2E throughput table (pipeline + socket rx)
9. Stable KPI table with fixed metric keys
10. Artifact paths
11. Verification commands (stable benchmark reproduction)
12. Machine-readable metrics block

Path policy:

- Commands and artifact paths in reports are always repository-relative
  (`benches/...`, `compiler/...`, `tmp/...`).
- Absolute machine-specific paths must not be emitted.

Numeric display policy:

- Human-facing tables use SI prefixes for large values (`K`, `M`, `G`, `T`, `P`).
- Raw values are preserved only in the machine-readable metrics block.

## Comparison Mechanism

- Every stable metric row has:
  - `Value`
  - `Delta vs prev`
- `Delta vs prev` is computed against the most recent previous
  `*-bench.md` file by filename timestamp (reverse lexicographic sort),
  excluding the report being written.
- Machine-readable block markers:
  - `<!-- PIPIT_METRICS_BEGIN -->`
  - `<!-- PIPIT_METRICS_END -->`
- Each metric line format:
  - `key|value|unit`

## Run

```bash
# Default (HEAD-based id)
./benches/commit_characterize.sh

# Pre-commit friendly (stable id from staged diff)
./benches/commit_characterize.sh --id-source staged-diff --skip-if-exists

# Explicit id, overwrite existing report
./benches/commit_characterize.sh --commit-id <id> --force
```
