# Performance Characterization Reports

`doc/performance/` stores one Markdown report per benchmarked snapshot:

- `<id>-characterize.md`

The report is generated by `benches/commit_characterize.sh`.

## ID Rule

- `--id-source head`:
  - `<id> = git rev-parse --short HEAD`
- `--id-source staged-diff`:
  - `<id> = short hash of staged diff (excluding existing characterization reports)`
  - This is stable across pre-commit retries and avoids infinite report regeneration loops.

## Fixed Output Format

Each report always includes these sections in order:

1. Metadata (`ID`, `HEAD`, `Branch`, previous report)
2. Commands used
3. Status (`runtime/e2e`, `compile`)
4. Full compile latency table (`simple`, `multitask`, `complex`, `modal`)
5. Runtime deadline miss rate table (`1kHz`, `10kHz`, `48kHz`)
6. Ring buffer contention table (`1/2/4/8 readers`)
7. E2E throughput table (pipeline + socket rx)
8. Stable KPI table with fixed metric keys
9. Artifact paths
10. Machine-readable metrics block

Path policy:

- Commands and artifact paths in reports are always repository-relative
  (`benches/...`, `compiler/...`, `tmp/...`).
- Absolute machine-specific paths must not be emitted.

Numeric display policy:

- Human-facing tables use SI prefixes for large values (`K`, `M`, `G`, `T`, `P`).
- Raw values are preserved only in the machine-readable metrics block.

## Comparison Mechanism

- Every stable metric row has:
  - `Value`
  - `Delta vs prev`
- `Delta vs prev` is computed against the most recently modified previous
  `*-characterize.md` file in this directory.
- Machine-readable block markers:
  - `<!-- PIPIT_METRICS_BEGIN -->`
  - `<!-- PIPIT_METRICS_END -->`
- Each metric line format:
  - `key|value|unit`

## Run

```bash
# Default (HEAD-based id)
./benches/commit_characterize.sh

# Pre-commit friendly (stable id from staged diff)
./benches/commit_characterize.sh --id-source staged-diff --skip-if-exists
```
