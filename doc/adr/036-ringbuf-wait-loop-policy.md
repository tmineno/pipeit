# ADR-036: RingBuffer Wait-Loop Policy — Hybrid Polling

## Context

生成されたタスク間リングバッファループは `std::this_thread::yield()` によるビジーリトライで、1,000,000 回の試行後にハードフェイルする。これにより以下の問題が発生する:

1. **CPU チャーン**: `yield()` ループはコンテンション下で CPU を浪費する
2. **非決定的タイムアウト**: 試行回数ベースのタイムアウトは実時間と無関係（CPU 速度依存）
3. **設定不可能**: 待機ポリシーやタイムアウト値をユーザーが制御できない

### 検討した選択肢

1. **C++20 `std::atomic::wait()` + `notify_one()`**: 効率的なブロッキングだが、`wait()` にはデッドラインパラメータがない。タイムアウトは `notify` またはスプリアスウェイクアップなしには到達不能。マルチリーダーの場合、`notify_one` は N 人の待機者のうち 1 人のみ起床する
2. **`futex` / プラットフォーム固有の待機**: デッドライン対応だが、ポータビリティが低い。クロスプラットフォームラッパーが必要
3. **ハイブリッドポーリング (spin → yield → sleep)**: ポータブル、タイムアウト保証、追加依存なし
4. **純粋 sleep ループ**: レイテンシが高い（最小 1ms）

## Decision

**ハイブリッドポーリング (spin → yield → sleep)** を採用する。`atomic_wait` は将来バージョンでプラットフォーム固有のタイムド待機ラッパーが利用可能になった段階で追加する。

### 1. 3 フェーズプログレッシブバックオフ

```
Phase 1: spin ~100 iterations     (sub-microsecond wakeup)
Phase 2: yield ~100 iterations    (OS reschedule, deadline check)
Phase 3: sleep 1ms increments     (until deadline)
```

- フェーズ 1 はサブマイクロ秒のウェイクアップを提供（データが直ちに利用可能な場合）
- フェーズ 2 は OS にスケジュール機会を与えつつ、デッドラインを確認
- フェーズ 3 はデッドラインまで 1ms 刻みでスリープ（CPU 節約）

### 2. WaitResult 列挙型

```cpp
enum class WaitResult { ready, timeout, stopped };
```

- `ready`: データ/スペースが利用可能
- `timeout`: デッドライン到達
- `stopped`: 停止シグナル検出

### 3. `set wait_timeout` ディレクティブ

タイムアウト値は `set wait_timeout = N` で設定可能（単位: ミリ秒、デフォルト: 50ms、範囲: 1–60000）。

### 4. なぜ `atomic_wait` を使わないか

- `std::atomic::wait(old)` は条件が満たされるまで（またはスプリアスウェイクアップまで）ブロックするが、**デッドラインパラメータがない**
- タイムアウト分岐は `notify` なしには到達不能 — ライターが停止した場合、リーダーは永久にブロックする可能性がある
- マルチリーダーの場合、`notify_one` は N 人の待機者のうち 1 人のみ起床する（他の N-1 人は飢餓状態）
- C++20 標準にはタイムド待機バリアントがない。プラットフォーム固有の `futex` / `WaitOnAddress` ラッパーが必要

## Consequences

- **ポータビリティ**: C++11 以降で動作（`<thread>`, `<chrono>`, `<atomic>` のみ使用）
- **タイムアウト保証**: 実時間ベースのデッドラインにより、決定的なタイムアウト動作
- **CPU 使用量**: フェーズ 1/2 はビジーウェイトだが、100 反復 × 2 = 数百マイクロ秒のみ。フェーズ 3 でスリープに移行
- **レイテンシ**: フェーズ 3 のスリープ最小単位は 1ms。サブミリ秒のウェイクアップはフェーズ 1/2 でカバー
- **将来の拡張**: `atomic_wait` パスを追加する場合、`wait_readable`/`wait_writable` の内部実装のみ変更。API は不変

## Exit Criteria

- [ ] 全コンパイラテスト通過
- [ ] 全ランタイムテスト通過（新規待機ループテスト含む）
- [ ] コンテンションベンチマークで v0.4.5 ベースラインに対する改善確認
