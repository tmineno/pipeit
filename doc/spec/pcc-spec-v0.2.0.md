# Feature: pcc — Pipit Compiler Collection

Version: 0.2.0

## 1. Goal

`pcc` is the compiler for Pipit Definition Language (`.pdl`) files. It reads a pipeline description and actor header files, performs static analysis, and produces either a standalone executable or generated C++ source code.

Refer to [pipit-lang-spec-v0.2.0](pipit-lang-spec-v0.2.0.md) for the full language semantics. This spec defines `pcc`'s behavior as a tool.

## 2. Non-goals

- `pcc` does not parse C++ actor bodies — it only reads `constexpr` registration metadata generated by the `ACTOR` macro
- `pcc` does not provide an incremental/watch mode (full recompilation only)
- `pcc` does not manage external C++ dependencies beyond `libpipit`
- IDE integration (LSP) is out of scope for v0.2.0

---

## 3. Implementation

`pcc` is implemented in Rust (see [ADR-001](../adr/001-rust-for-pcc.md)). The generated C++ code links against the `libpipit` runtime library (C++17). There is no Rust–C++ FFI; `pcc` reads actor metadata from header files and invokes the system C++ compiler as a subprocess.

---

## 4. Software Architecture

```
                         ┌─────────────────────────────────────────────┐
                         │              pcc (Rust binary)              │
                         │                                             │
  ┌──────────┐           │  ┌─────────┐   ┌───────────────────────┐   │
  │ .pdl     │──────────▶│  │  Lexer  │──▶│  Parser               │   │
  │ source   │           │  └─────────┘   │  (AST)     [emit ast] │   │
  └──────────┘           │                └───────────┬───────────┘   │
                         │                            │               │
  ┌──────────┐           │  ┌─────────────────────┐   │               │
  │ actors.h │──────────▶│  │  Actor Registry     │   │               │
  │ (-I)     │           │  │  (metadata reader)  │───┤               │
  └──────────┘           │  └─────────────────────┘   │               │
                         │                            ▼               │
                         │                ┌───────────────────────┐   │
                         │                │  Name Resolution      │   │
                         │                └───────────┬───────────┘   │
                         │                            ▼               │
                         │                ┌───────────────────────┐   │
                         │                │  SDF Graph Builder    │   │
                         │                │           [emit graph]│   │
                         │                └───────────┬───────────┘   │
                         │                            ▼               │
                         │                ┌───────────────────────┐   │
                         │                │  Static Analysis      │   │
                         │                │  (types, rates,       │   │
                         │                │   balance, buffers)   │   │
                         │                └───────────┬───────────┘   │
                         │                            ▼               │
                         │                ┌───────────────────────┐   │
                         │                │  Schedule Generator   │   │
                         │                └───────────┬───────────┘   │
                         │                            ▼               │
                         │                ┌───────────────────────┐   │   ┌──────────────┐
                         │                │  C++ Code Generator   │───┼──▶│ *_gen.cpp    │
                         │                │           [emit cpp]  │   │   │ [emit cpp]   │
                         │                └───────────────────────┘   │   └──────────────┘
                         └────────────────────────┬───────────────────┘
                                                  │ [emit exe]
                                                  │ invokes subprocess
                                                  ▼
                         ┌─────────────────────────────────────────────┐
                         │          System C++ Compiler (--cc)         │
                         │          g++ / clang++ -O2 -lpipit          │
                         └────────────────────────┬────────────────────┘
                                                  │
                              ┌────────────────┐  │  ┌────────────────┐
                              │ libpipit       │──┘  │                │
                              │ (C++ runtime)  │────▶│  executable    │
                              └────────────────┘     └────────────────┘
```

### 4.1 Module mapping (Rust crate: `pcc`)

| Module | Responsibility |
|--------|---------------|
| `lexer` | Tokenize `.pdl` source (§2) |
| `parser` | Build AST from token stream (§10 BNF) |
| `actor_registry` | Read `ACTOR` macro metadata from C++ headers (§4) |
| `resolve` | Name resolution — actors, consts, params, buffers, taps |
| `graph` | SDF graph construction — tap expansion, define inlining, inter-task edges |
| `analysis` | Static analysis — type check, balance equations, buffer sizing, CSDF |
| `schedule` | Schedule generation — topological order, K determination, batching, rate-domain fusion planning |
| `codegen` | C++ code emission — schedule loops, ring buffers, main() |
| `diag` | Diagnostic infrastructure — errors, warnings, source locations |

### 4.2 Data flow between modules

```
.pdl source ─▶ lexer ─▶ Vec<Token>
                            │
                            ▼
                        parser ─▶ AST
                                   │
actors.h ─▶ actor_registry ─▶ Registry
                                   │
                            ┌──────┴──────┐
                            ▼             ▼
                        resolve(AST, Registry) ─▶ ResolvedAST
                                                       │
                                                       ▼
                                                 graph(ResolvedAST) ─▶ SDFGraph
                                                                          │
                                                                          ▼
                                                                   analysis(SDFGraph) ─▶ AnalyzedGraph
                                                                                             │
                                                                                             ▼
                                                                                       schedule(AnalyzedGraph) ─▶ Schedule
                                                                                                                     │
                                                                                                                     ▼
                                                                                                               codegen(Schedule) ─▶ C++ source
```

---

## 5. Inputs

### 5.1 Source file (required)

A single `.pdl` file containing the pipeline description.

```
pcc example.pdl [OPTIONS]
```

### 5.2 Actor headers (`-I`)

One or more C++ header files containing `ACTOR` macro definitions. `pcc` reads only the `constexpr` registration functions generated by these macros — it does not parse general C++ code.

```
pcc example.pdl -I ./actors.h -I ./extra_actors.h
```

If no `-I` flag is provided and actors are referenced in the `.pdl` file, compilation fails with a name resolution error.

### 5.3 Actor search path (`--actor-path`)

Directories to search for actor registration metadata. `pcc` scans these directories for headers containing `ACTOR` registrations.

```
pcc example.pdl --actor-path ./actors/ --actor-path /usr/include/pipit/
```

`-I` takes precedence over `--actor-path` when the same actor name is found in both.

---

## 6. Outputs

### 6.1 Default: Executable

By default, `pcc` generates C++ source code, invokes the system C++ compiler, and links against `libpipit` to produce an executable.

```
pcc example.pdl -I actors.h -o receiver
# produces: ./receiver
```

### 6.2 `--emit cpp`: Generated C++ source only

Stop after code generation without invoking the C++ compiler. Useful for inspection and custom build integration.

```
pcc example.pdl -I actors.h --emit cpp -o receiver_gen.cpp
# produces: receiver_gen.cpp
```

### 6.3 `--emit ast`: AST dump

Dump the parsed AST in a human-readable format. For debugging the compiler frontend.

```
pcc example.pdl --emit ast
```

### 6.4 `--emit graph`: SDF graph dump

Dump the constructed SDF graph with repetition vectors and buffer sizes. For debugging the analysis phase.

```
pcc example.pdl -I actors.h --emit graph
```

---

## 7. CLI Interface

```
pcc <source.pdl> [OPTIONS]
```

| Flag | Type | Default | Description |
|------|------|---------|-------------|
| `-o <path>` | PATH | `a.out` | Output file path |
| `-I <file>` | PATH (repeatable) | — | Actor header file |
| `--actor-path <dir>` | PATH (repeatable) | — | Actor search directory |
| `--emit <stage>` | `exe` \| `cpp` \| `ast` \| `graph` | `exe` | Output stage |
| `--release` | flag | off | Release build: strip probes, enable optimizations |
| `--cc <compiler>` | STRING | `c++` | C++ compiler command |
| `--cflags <flags>` | STRING | `-O2` | Additional C++ compiler flags |
| `--verbose` | flag | off | Print compiler phases and timing |
| `--version` | flag | — | Print version and exit |
| `--help` | flag | — | Print usage and exit |

### 7.1 Release vs Debug build

| Behavior | Debug (default) | Release (`--release`) |
|----------|-----------------|----------------------|
| Probe instrumentation | Included | Stripped (zero cost) |
| C++ optimization | `-O0 -g` | `-O2` |
| Runtime assertions | Enabled | Disabled |

When `--cflags` is explicitly provided, it overrides the default optimization flags for both modes.

---

## 8. Actor Discovery

`pcc` discovers actor metadata through the `constexpr` registration functions generated by the `ACTOR` macro. The discovery process:

1. Read files specified by `-I` flags
2. Scan directories specified by `--actor-path` for headers
3. Extract registration metadata: actor name, input type, input token count, output type, output token count, parameter list
4. Build an actor registry keyed by name

Duplicate actor names across different headers are a compile error:

```
error: duplicate actor definition 'fft'
  first defined in: actors.h
  also defined in:  extra_actors.h
```

---

## 9. Compilation Phases

`pcc` executes the following phases sequentially. A failure in any phase halts compilation.

```
source.pdl + actors.h
  │
  ├─ 1. Lex & Parse                          [--emit ast]
  │     └─ Tokenize .pdl source, build AST
  │
  ├─ 2. Actor Loading
  │     └─ Read constexpr registration info from ACTOR macros
  │        (name, in/out type, token counts, params)
  │
  ├─ 3. Name Resolution
  │     ├─ Actor names: lookup in registry (parenthesized only)
  │     ├─ Shared buffer names: -> defines, @ references
  │     ├─ Tap names: : defines/references (task scope)
  │     ├─ const / param names: global scope
  │     └─ Collision detection (no duplicates in same namespace)
  │
  ├─ 4. SDF Graph Construction               [--emit graph]
  │     ├─ Expand taps to fork nodes
  │     ├─ Inline-expand define sub-pipelines
  │     ├─ Convert shared buffers to inter-task edges
  │     ├─ Build control subgraph as independent sub-graph
  │     └─ Build each mode block as independent sub-graph
  │
  ├─ 5. Static Analysis
  │     ├─ Type compatibility at pipe endpoints
  │     ├─ SDF balance equation solving → repetition vector
  │     ├─ Feedback loop delay verification
  │     ├─ Cross-clock rate matching (Pw×fw = Cr×fr)
  │     ├─ CSDF per-mode analysis
  │     ├─ ctrl supplier verification
  │     └─ Buffer size computation (safe upper bound)
  │
  ├─ 6. Schedule Generation
  │     ├─ Per-task topological order (PASS construction)
  │     ├─ K (iterations/tick) determination
  │     ├─ Rate-domain (fusion-domain) detection
  │     └─ Batching optimization for high target rates
  │
  ├─ 7. C++ Code Generation                  [--emit cpp]
  │     ├─ Ring buffer static allocation
  │     ├─ Per-task schedule loop
  │     ├─ Runtime parameter double-buffering
  │     ├─ Overrun detection and statistics
  │     ├─ Probe instrumentation (stripped in --release)
  │     └─ main() with CLI argument parser
  │
  └─ 8. C++ Compilation                      [--emit exe]
        └─ Invoke cc -O2 -lpipit → executable
```

| Phase | Description | Can emit here |
|-------|-------------|---------------|
| 1. Lex & Parse | Tokenize `.pdl`, build AST | `--emit ast` |
| 2. Actor Loading | Read `constexpr` registration info from headers | |
| 3. Name Resolution | Resolve actors, consts, params, buffers, taps | |
| 4. SDF Graph Construction | Expand taps, inline defines, build inter-task edges | `--emit graph` |
| 5. Static Analysis | Type check, balance equations, buffer sizing | |
| 6. Schedule Generation | Topological order, K determination, rate-domain detection, batching | |
| 7. C++ Code Generation | Emit C++ source with runtime integration | `--emit cpp` |
| 8. C++ Compilation | Invoke system compiler, link `libpipit` | `--emit exe` |

### 9.1 Rate-domain (fusion-domain) optimization

To reduce loop overhead while preserving SDF semantics, `pcc` MAY group adjacent firings into a `rate domain` and emit a fused inner loop.

`rate domain` (aka `fusion domain`) is an implementation-level schedule unit and is not a DSL construct.

#### 9.1.1 Eligibility (all required)

- Same task and same subgraph (`pipeline`, `control`, or one mode subgraph)
- Adjacent in topological firing order
- Equal repetition count
- Single-rate compatibility along the grouped path (per-firing token transfer matches on each grouped edge)
- No feedback back-edge crossing (`delay` cycle cut edges are barriers)
- No barrier nodes that require standalone placement (e.g., shared-buffer read/write boundaries)

#### 9.1.2 Correctness constraints

When fusion is applied, generated code MUST preserve:

- Iteration semantics from the language spec (one iteration still fires each actor exactly `rep(node)` times)
- Per-edge FIFO token order
- Observable side-effect order (`stdout`, file/network sinks, probes, shared-buffer write/read order)
- Existing error behavior (`ACTOR_ERROR` short-circuits task execution exactly as before)

#### 9.1.3 Non-requirement

Fusion is optional. If eligibility is not met, `pcc` may emit the unfused per-node loop form.

---

## 10. Error Output Format

All diagnostics are written to stderr in the following format:

```
<level>: <message>
  at <file>:<line>:<column>
  <context line>
  <caret indicator>
  hint: <suggestion>
```

### 10.1 Levels

| Level | Meaning |
|-------|---------|
| `error` | Compilation cannot continue. Exit code 1. |
| `warning` | Potential issue, compilation continues. |
| `note` | Additional context attached to a preceding error or warning. |

### 10.2 Error categories

Errors are classified by phase (see lang spec §7.1 for the full catalog):

| Category | Example |
|----------|---------|
| Syntax | Unexpected token, missing `}` |
| Name resolution | Unknown actor, undefined buffer |
| Type mismatch | Pipe endpoint types differ |
| Rate mismatch | Cross-clock `Pw × fw ≠ Cr × fr` |
| SDF | Balance equation unsolvable, missing delay |
| Constraint | Multiple writers, unused tap |
| Memory | Buffer total exceeds `set mem` |
| Actor | Duplicate definition, missing registration |

### 10.3 Example

```
error: type mismatch at pipe 'fft -> fir'
  at example.pdl:12:25
    adc(0) | fft(256) | fir(coeff) -> signal
                        ^^^^^^^^^^
  fft outputs cfloat[256], but fir expects float[5]
  hint: insert a conversion actor (e.g. c2r)
```

---

## 11. Exit Codes

| Code | Meaning |
|------|---------|
| `0` | Compilation succeeded |
| `1` | Compilation failed (source errors) |
| `2` | Usage error (invalid flags, missing input file) |
| `3` | System error (C++ compiler not found, write permission denied) |

---

## 12. Generated Code Structure

When `--emit cpp` is used, the generated file contains:

1. **Includes**: `<pipit.h>`, actor headers, standard library headers
2. **Static storage**: `const` arrays, ring buffer allocations, parameter initial values
3. **Task functions**: One function per task containing the schedule loop
4. **Mode dispatch** (if CSDF): Control subgraph execution + mode switch logic
5. **Double-buffer swap points**: Runtime parameter updates at iteration boundaries
6. **`main()`**: CLI argument parser (`--duration`, `--threads`, `--param`, `--probe`, `--stats`), thread launch, signal handler, graceful shutdown

The generated code depends only on:

- `libpipit` (runtime library)
- Actor headers provided via `-I`
- C++17 standard library

---

## 13. Performance / Safety

- Compilation of a 100-actor graph should complete in under 1 second on commodity hardware
- Memory usage scales linearly with graph size; no unbounded allocations during compilation
- `pcc` never executes user-provided code — it only reads metadata
- Generated code inherits safety properties from `libpipit` (bounded buffers, no dynamic allocation at runtime)

---

## 14. Acceptance Tests

```bash
# 1. Compile and produce executable
pcc example.pdl -I actors.h -o example
test -x ./example

# 2. Emit C++ source only
pcc example.pdl -I actors.h --emit cpp -o example_gen.cpp
test -f ./example_gen.cpp

# 3. AST dump completes without error
pcc example.pdl --emit ast

# 4. Graph dump shows repetition vectors and buffer sizes
pcc example.pdl -I actors.h --emit graph | grep "repetition_vector"
pcc example.pdl -I actors.h --emit graph | grep "buffer_size"

# 5. Type mismatch produces actionable error
echo 'clock 1kHz t { adc(0) | fir(coeff) -> out }' > bad.pdl
pcc bad.pdl -I actors.h 2>&1 | grep "error: type mismatch"

# 6. Missing actor header produces name resolution error
pcc example.pdl 2>&1 | grep "error:"

# 7. Release build strips probes
pcc example.pdl -I actors.h --release -o example_rel
# (verify no probe symbols in binary)

# 8. Version and help flags
pcc --version
pcc --help

# 9. CSDF example compiles
pcc receiver.pdl -I actors.h -o receiver
test -x ./receiver

# 10. Invalid flag returns exit code 2
pcc --invalid-flag; test $? -eq 2
```
